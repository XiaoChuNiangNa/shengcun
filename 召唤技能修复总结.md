# 召唤技能分身显示修复总结

## 问题分析
对战系统中召唤技能生成的分身卡牌不显示在场上的问题主要由以下几个原因造成：

### 1. UI显示逻辑缺陷
- `updateUI()` 方法中只更新了单位数据，但没有控制卡牌的可见性
- 布局文件中卡牌默认是 `android:visibility="gone"` 状态，需要动态设置为可见

### 2. 召唤单位创建不完整
- `useSummonSkill()` 方法虽然创建了召唤单位，但没有正确设置主单位关系和持续时间
- 没有根据技能等级调整分身的属性比例

### 3. 召唤单位生命周期管理缺失
- 没有处理召唤单位的持续时间逻辑
- 召唤单位持续时间结束后没有被正确移除

## 修复方案

### 1. 修复 `updateUI()` 方法
- 添加卡牌容器引用获取逻辑
- 根据单位存在状态动态设置卡牌可见性：有单位时设置为 `VISIBLE`，无单位时设置为 `GONE`
- 确保召唤单位的数据能正确显示在UI上

### 2. 完善召唤技能逻辑
- 根据技能等级计算分身生命值比例（Lv1: 50%, Lv2: 75%, Lv3: 100%）
- 设置召唤单位的主单位关系和持续时间（5回合）
- 添加详细的战斗日志信息

### 3. 添加召唤单位生命周期管理
- 新增 `processSummonDuration()` 方法处理召唤单位持续时间
- 每回合开始时检查并减少召唤单位剩余时间
- 持续时间结束时自动移除召唤单位并显示日志

### 4. 优化战斗逻辑
- 改进敌方目标选择逻辑，确保能正确选择召唤单位作为攻击目标
- 在 `initBattleUnits()` 中初始化所有卡牌为隐藏状态
- 优化召唤技能在 BattleSkillManager 中的处理逻辑

## 主要修改文件

1. **BattleActivity.java**
   - 修复 `updateUI()` 方法的卡牌可见性控制
   - 完善 `useSummonSkill()` 方法的召唤单位创建逻辑
   - 添加 `processSummonDuration()` 方法
   - 优化 `initBattleUnits()` 和 `selectEnemyTarget()` 方法

2. **BattleSkillManager.java**
   - 简化 SUMMON 技能的处理逻辑，实际创建交由 BattleActivity 处理

## 测试要点

1. **基础功能测试**
   - 使用召唤技能后检查分身是否正确显示在场上
   - 验证分身的属性值是否符合技能等级
   - 确认分身能正常参与战斗

2. **生命周期测试**
   - 验证召唤单位持续5回合后自动消失
   - 检查每回合的持续时间提醒日志
   - 确认分身消失后卡牌正确隐藏

3. **交互测试**
   - 验证敌人能正确选择召唤单位作为攻击目标
   - 测试分身受到伤害和死亡的逻辑
   - 确认多个召唤单位的显示和管理

## 技术细节

### 卡牌可见性控制
```java
// 获取卡牌容器并设置可见性
View playerCard = findViewById(cardId);
if (playerUnit != null) {
    playerCard.setVisibility(View.VISIBLE);
} else {
    playerCard.setVisibility(View.GONE);
}
```

### 召唤单位创建
```java
BattleUnit summonedUnit = new BattleUnit(
    "召唤分身",
    (int)(caster.getMaxHealth() * healthRatio),
    caster.getAttack() / 2,
    caster.getDefense() / 2,
    caster.getSpeed(),
    new BattleSkill[0],
    BattleUnit.TYPE_SUMMON
);
summonedUnit.setMaster(caster);
summonedUnit.setSummonDuration(SUMMON_DURATION);
```

### 持续时间管理
```java
private void processSummonDuration() {
    // 每回合减少持续时间，到0时移除单位
    if (remainingDuration <= 0) {
        addBattleLog(unitName + " 持续时间结束，消失了");
        playerUnits[i] = null;
    }
}
```

这些修复确保了召唤技能的完整功能，包括分身的正确显示、属性管理和生命周期控制。